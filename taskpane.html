<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://osbrodn.github.io; connect-src 'self' https://api.openai.com; script-src 'self' https://appsforoffice.microsoft.com https://osbrodn.github.io; style-src 'self' 'unsafe-inline' https://static2.sharepointonline.com;">
    <title>Asistente Ejecutivo IA</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background-color: #1e1e1e; color: #ffffff; }
        .card { background: #2b2b2b; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-left: 5px solid #3498db; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; margin-bottom: 15px; background: #3498db; color: white; }
        #ai-summary { font-style: italic; color: #3498db; font-size: 14px; line-height: 1.6; margin-bottom: 20px; min-height: 40px; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        .btn { border: none; padding: 12px; cursor: pointer; font-weight: 600; border-radius: 8px; transition: 0.3s; text-transform: uppercase; font-size: 12px; }
        .btn-start { background: #2ecc71; color: white; }
        .btn-ai { background: #9b59b6; color: white; }
        .btn-stop { background: #e74c3c; color: white; }
        .btn:hover { opacity: 0.8; transform: scale(1.02); }
        .loading { color: #f1c40f; font-size: 12px; display: none; }
    </style>
</head>
<body>
    <div class="card">
        <div id="badge" class="status-badge">MODO EJECUTIVO ACTIVO</div>
        <div id="loading-text" class="loading">Consultando a GPT-4o-mini...</div>
        <div id="ai-summary">Selecciona un correo para generar el resumen inteligente...</div>
        
        <div class="btn-group">
            <button id="btn-resumen" class="btn btn-ai">‚ú® GENERAR RESUMEN (OPENAI)</button>
            <button id="btn-read" class="btn btn-start">üîä LEER CORREO COMPLETO</button>
            <button id="btn-stop" class="btn btn-stop">‚èπÔ∏è DETENER</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE TU APP DE PYTHON ---
        const OPENAI_API_KEY = "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"; 
        const VOZ_MEXICO = "es-MX-DaliaNeural"; // Intentaremos buscar esta
        
        let cuerpoOriginal = "";
        const synth = window.speechSynthesis;

        Office.onReady((info) => {
            if (info.host === Office.HostType.Outlook) {
                Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, cargarCorreo);
                cargarCorreo();
            }
        });

        function cargarCorreo() {
            synth.cancel();
            document.getElementById('ai-summary').innerText = "Nuevo correo detectado. Listo para resumir.";
            Office.context.mailbox.item.body.getAsync(Office.CoercionType.Text, (result) => {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    cuerpoOriginal = result.value.trim();
                }
            });
        }

        async function obtenerResumenInteligente(texto) {
            document.getElementById('loading-text').style.display = "block";
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            { role: "system", content: "Eres un asistente ejecutivo. Resume el correo en una sola frase corta y clara en espa√±ol de M√©xico." },
                            { role: "user", content: texto }
                        ],
                        max_tokens: 60
                    })
                });
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error("Error con OpenAI:", error);
                return "No pude conectar con la IA. Revisa tu API Key.";
            } finally {
                document.getElementById('loading-text').style.display = "none";
            }
        }

        function hablar(texto) {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(texto);
            
            // BUSCAR VOZ MEXICANA (Dalia o similar)
            const voces = synth.getVoices();
            const vozMX = voces.find(v => v.lang === 'es-MX' && v.name.includes('Dalia')) || 
                         voces.find(v => v.lang === 'es-MX') || 
                         voces.find(v => v.lang.includes('es'));
            
            if (vozMX) utterance.voice = vozMX;
            utterance.lang = 'es-MX';
            utterance.rate = 0.9; 
            synth.speak(utterance);
        }

        document.getElementById('btn-resumen').onclick = async () => {
            if (!cuerpoOriginal) return;
            const resumen = await obtenerResumenInteligente(cuerpoOriginal);
            document.getElementById('ai-summary').innerText = resumen;
            hablar(resumen);
            marcarLeido();
        };

        document.getElementById('btn-read').onclick = () => {
            hablar(cuerpoOriginal);
            marcarLeido();
        };

        document.getElementById('btn-stop').onclick = () => synth.cancel();

        function marcarLeido() {
            Office.context.mailbox.item.readStateSetAsync(true);
        }
    </script>
</body>
</html>