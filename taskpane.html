<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Asistente de Voz IA Pro</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background-color: #f3f2f1; color: #323130; }
        .card { background: white; border-radius: 4px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.14); border-top: 4px solid #0078d4; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .priority-high { background: #fde7e9; color: #a4262c; }
        .priority-normal { background: #dff6dd; color: #107c10; }
        
        #content { background: #faf9f8; border: 1px solid #edebe9; padding: 10px; height: 140px; overflow-y: auto; font-size: 13px; line-height: 1.5; margin-bottom: 15px; border-radius: 2px; white-space: pre-wrap; }
        
        .btn-group { display: flex; flex-direction: column; gap: 8px; }
        .btn { border: none; padding: 12px; cursor: pointer; font-weight: 600; border-radius: 2px; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .btn-main { background: #0078d4; color: white; }
        .btn-ai { background: #8e24aa; color: white; }
        .btn-outline { background: white; border: 1px solid #0078d4; color: #0078d4; display: none; }
        .btn-stop { background: #a4262c; color: white; margin-top: 5px; }
        .btn:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="card">
        <div id="badge" class="status-badge priority-normal">Analizando...</div>
        <div id="content">Esperando selecci√≥n de correo...</div>
        
        <div class="btn-group">
            <button id="btn-read" class="btn btn-main">üîä LEER Y MARCAR LE√çDO</button>
            <button id="btn-translate" class="btn btn-outline">üåç TRADUCIR A ESPA√ëOL</button>
            <button id="btn-resumen" class="btn btn-ai">‚ú® RESUMEN INTELIGENTE</button>
            <button id="btn-stop" class="btn btn-stop">‚èπÔ∏è DETENER LECTURA</button>
        </div>
    </div>

    <script>
        let cuerpoOriginal = "";
        let idiomaDetectado = "es";
        const synth = window.speechSynthesis;

        Office.onReady((info) => {
            if (info.host === Office.HostType.Outlook) {
                // Detecta autom√°ticamente cuando el usuario cambia de correo sin cerrar el panel
                Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, cargarContenido);
                cargarContenido();
            }
        });

        function cargarContenido() {
            synth.cancel(); // Detener voz si se cambia de correo
            Office.context.mailbox.item.body.getAsync(Office.CoercionType.Text, (result) => {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    cuerpoOriginal = result.value.trim();
                    document.getElementById('content').innerText = cuerpoOriginal;
                    actualizarPrioridad(cuerpoOriginal);
                    detectarIdioma(cuerpoOriginal);
                }
            });
        }

        function detectarIdioma(texto) {
            const palabrasIngles = ["the", "this", "hello", "regards", "meeting", "attached", "subject"];
            const esIngles = palabrasIngles.some(p => texto.toLowerCase().includes(p));
            
            const btnTrans = document.getElementById('btn-translate');
            if (esIngles) {
                idiomaDetectado = "en";
                btnTrans.style.display = "block";
            } else {
                idiomaDetectado = "es";
                btnTrans.style.display = "none";
            }
        }

        function hablar(texto, lang = 'es-ES') {
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = lang;
            utterance.rate = 1.0;
            synth.speak(utterance);
        }

        function marcarComoLeido() {
            Office.context.mailbox.item.readStateSetAsync(true);
        }

        // --- ACCIONES DE BOTONES ---

        document.getElementById('btn-read').onclick = () => {
            marcarComoLeido();
            hablar(cuerpoOriginal, idiomaDetectado === "es" ? 'es-ES' : 'en-US');
        };

        document.getElementById('btn-translate').onclick = () => {
            // Simulaci√≥n visual de traducci√≥n
            const textoTraducido = "[CONTENIDO TRADUCIDO AL ESPA√ëOL]:\n\n" + cuerpoOriginal; 
            document.getElementById('content').innerText = textoTraducido;
            idiomaDetectado = "es"; // Ahora la lectura ser√° en espa√±ol
            // No habla autom√°ticamente, espera a que el usuario presione "Leer" o "Resumen"
        };

        document.getElementById('btn-resumen').onclick = () => {
            if (!cuerpoOriginal) return;
            
            // Algoritmo: Extrae hasta las primeras 3 oraciones completas
            const oraciones = cuerpoOriginal.match(/[^\.!\?]+[\.!\?]+/g) || [cuerpoOriginal];
            let resumen = "Resumen del asistente: ";
            
            if (oraciones.length >= 1) {
                resumen += oraciones.slice(0, 3).join(" ");
            } else {
                resumen += cuerpoOriginal.substring(0, 150) + "...";
            }
            
            document.getElementById('content').innerText = resumen;
            hablar(resumen, 'es-ES');
            marcarComoLeido();
        };

        document.getElementById('btn-stop').onclick = () => synth.cancel();

        function actualizarPrioridad(texto) {
            const urgencia = /urgente|importante|error|falla|atenci√≥n|prioridad|inmediato/i;
            const esAlta = urgencia.test(texto);
            const badge = document.getElementById('badge');
            badge.innerText = esAlta ? "Prioridad: ALTA" : "Prioridad: NORMAL";
            badge.className = "status-badge " + (esAlta ? "priority-high" : "priority-normal");
        }
    </script>
</body>
</html>